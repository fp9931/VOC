clc
clear all

% Define general path
currentPath = pwd;
pathParts = strsplit(currentPath, filesep);
numParts = numel(pathParts);
newPathParts = pathParts(1:numParts-1);
rootPath = strjoin(newPathParts, filesep);
timings_path = fullfile(rootPath, '\Results\timings');

data_path = fullfile(rootPath, '\Data');
folders = dir(data_path);
folders_clean = folders(3:end);

for f=6:length(folders_clean)

    phonation_path = fullfile(data_path, folders_clean(f).name);
    files = dir(fullfile(phonation_path, '*.wav'));
    
    column_name = ["Start", "Stop"];
    times = zeros(length(files),2);
    
    for i=1:length(files)
        clc; disp(['Processing file ', num2str(i)])
        name = files(i).name(1:5);

        [y, fs] = audioread(fullfile(files(i).folder, files(i).name));
    
        order = 5;
        fc = [50, 1000]/(fs/2);
        [b,a] = butter(order,fc,"bandpass");
        filtered_y = filtfilt(b,a,y);

        filtered_y = filtered_y-mean(filtered_y);
        filtered_y = filtered_y/max(filtered_y);
    
        y_abs = abs(filtered_y);
        lp_cutoff = 10 / (fs/2);
        [b_lp, a_lp] = butter(2, lp_cutoff, "low");
        envelope = filtfilt(b_lp, a_lp, y_abs);
    
        th_time = 0.5*mean(envelope);
    
        above_points = envelope >=th_time;
    
        limits = diff([0; above_points]);
    
        local_min = find(islocalmin(envelope) ~= 0);
    
        start = 0;
        stop = length(envelope);
    
        start_temp = find(limits == 1);
        stop_temp = find(limits == -1);
    
        if (length(stop_temp) < length(start_temp))
            stop_temp = [stop_temp;length(envelope)];
        end
        
        start = [];
        stop = [];
        if ~isempty(start_temp)
            for k=1:length(start_temp)
                start_true = start_temp(k);
                stop_true = stop_temp(k);
                before_start = local_min(local_min < start_true);
                start = [start; before_start(end)];
                after_stop = local_min(local_min > stop_true);
                if ~isempty(after_stop)
                    stop = [stop; after_stop(1)];
                end
            end
  
        else
            start = 0;
            stop = length;
        end
      
        figure();plot(envelope);hold on;title(files(i).name(1:5))
        xline(start);
        xline(stop);
        yline(th_time)

        % figure();plot(y);hold on;title(files(i).name(1:5))
        % xline(start);
        % xline(stop);
        % yline(th_time)
 
        % tab = table(start_time./fs,stop_time./fs,'VariableNames',column_name);
        % writetable(tab,fullfile(timings_path,folders_clean(f).name,[name,'.xlsx']))
       
    end
    break
end